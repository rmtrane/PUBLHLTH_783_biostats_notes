---
title: "Biostats Lecture 4: Estimators & Their Distributions"
subtitle: "Public Health 783"
author: "Ralph Trane"
institute: "University of Wisconsin--Madison<br><br>"
date: "Fall 2019"
output:
  xaringan::moon_reader:
    self_contained: true
    css: [../css/uwmadison.css, default-fonts, ../css/extra-classes.css]
    lib_dir: libs
    nature:
      titleSlideClass: [center, top, .title-slide]
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ration: '16:9'
      navigation:
        scroll: false
---

```{r include = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, dpi=300)

options(DT.options = list(scrollX = TRUE))

library(tidyverse)
library(viridis)

library(ggalt)

## Set theme for plots (only works when you load ggplot2, which can be done using library(ggplot2) OR with library(tidyverse))
theme_set(theme_bw())

scale_color_continuous <- function(...) scale_color_viridis_c(...)
scale_fill_continuous <- function(...) scale_fill_viridis_c(...)

scale_color_discrete <- function(...) scale_color_viridis_d(...)
scale_fill_discrete <- function(...) scale_fill_viridis_d(...)

framingham <- read_csv("../../data/Framingham/framingham.csv") %>% 
  rename(gender = male) %>% 
  mutate(gender = if_else(gender == 1, 'male', 'female'))

show <- read_csv("~/Documents/UW-Madison/PUBLHLTH783/labs/show_for_lab.csv")

samples <- tibble(Student = list.files("~/Documents/UW-Madison/PUBLHLTH783/labs/lab4/data/")) %>% 
  mutate(data = map(Student, ~readr::read_csv(paste("~/Documents/UW-Madison/PUBLHLTH783/labs/lab4/data", .x, sep = '/'))))
```

layout: true

# Estimators & Their Distributions

---

## Follow-up on todays lab

Let's just consider the relationship between BMI and depression.

You all had a sample of $50$ subjects. I performed all `r nrow(samples)` surveys on your behalves.
--

(In reality, I gave you random samples from the SHOW population, sampled completely at random among subjects with complete data.)

You all calculated a bunch of things, including the mean BMI in each of the two groups (depressed vs. not depressed)

As the almighty lecturer, I have access to all the samples...

---

.center[
```{r out.width = 500, out.height = 500}
## create boxplot with means from student samples
student_boxplot <- samples %>%
  mutate(mean = map(.x = data,
                    ~.x %>% group_by(depression) %>% summarize(m = mean(bmi, na.rm = TRUE)))) %>%
  unnest(col = 'mean') %>%
  ggplot(aes(x = depression, y = m)) +
    geom_boxplot() +
    geom_jitter(width = 0.2, height = 0, aes(label = Student)) +
    labs(y = 'Mean BMI')

plotly::ggplotly(student_boxplot)
```
]

---

.center[
```{r out.width = 600, out.height=550}
for_dumbbell <- samples %>%
  mutate(bmi_locations = map(data, ~.x %>%
                               group_by(depression) %>%
                               summarise(med = median(bmi, na.rm = T),
                                         mean = mean(bmi, na.rm = T)) %>%
                               gather(key = 'stat', value = 'value', med, mean)),
         Student = str_remove(Student, ".csv") %>% 
           str_replace("_", " ")) %>%
  unnest(bmi_locations) %>%
  spread(depression, value)

for_dumbbell_mean <- for_dumbbell %>%
  filter(stat == 'mean') %>%
  mutate(Student = factor(Student, levels = Student[order(Depressed, decreasing = T)]))


dumbbell_mean <- ggplot(data = for_dumbbell_mean,
       aes(x = Depressed, xend = `Not Depressed`, y = Student, group = Student)) +
  geom_point(data = for_dumbbell_mean %>% gather(key = 'key', value = 'value', `Not Depressed`, Depressed),
             inherit.aes = F,
             aes(x = value, y = Student, color = key)) +
  geom_dumbbell(colour_x = 'blue', colour_xend = 'red') +
  scale_color_manual(values = c('blue', 'red')) +
  labs(title = 'Mean', color = '', x = 'BMI')

dumbbell_mean
```
]

---


.center[
```{r out.width = 600, out.height = 450, fig.width = 6, fig.height = 4.5}
depression_bmi <- show %>%
  ggplot(aes(x = bmi, fill = depression)) +
    geom_histogram(aes(y = ..density..)) + 
    geom_vline(data = show %>% 
                 group_by(depression) %>% 
                 summarise(mean_bmi = mean(bmi)),
               aes(xintercept = mean_bmi),
               color = 'red', linetype = 'dashed') + 
    facet_grid(depression~.) + 
    ggtitle("BMI distribution in full SHOW data")
depression_bmi
```
]

---

```{r out.width = 600, out.height = 450, fig.width = 6, fig.height = 4.5}
samples %>% 
  mutate(means = map(data, 
                     ~.x %>% group_by(depression) %>% summarize(bmi = mean(bmi)))) %>% 
  unnest(means) %>% 
  ggplot(aes(x = bmi, fill = depression)) +
    geom_histogram(aes(y = ..density..),
                   bins = 22) + 
    geom_vline(data = show %>% 
                 group_by(depression) %>% 
                 summarise(mean_bmi = mean(bmi)),
               aes(xintercept = mean_bmi),
               color = 'red', linetype = 'dashed') + 
    facet_grid(depression~.) + 
    theme(legend.position = 'none')
```

---

.center[
.middle[
## Motivational Spiel
]
]

---

## Examples of Estimators

| Parameter of Interest (most commonly used symbol)         | Estimator Name                    | Notation and Formula                                      |
|:---------------------------------------------------------:|:---------------------------------:|:---------------------------------------------------------:|
| Mean of a feature $\mu$                                   | Sample average                    | $\bar{X} = \frac{1}{n} \sum_{i=1}^n X_i$                  |
| Variance of a feature $\sigma^2$                          | Sample variance                   | $S^2 = \frac{1}{n-1} \sum_{i=1}^n (X_i - \bar{X})^2$      |
| Standard deviation $\sigma$                               | Sample standard deviation         | $S = \sqrt{\frac{1}{n-1} \sum_{i=1}^n (X_i - \bar{X})^2}$ |
| Probability of random individual having a disease $\pi$   | Proportion in sample with disease | $P = \frac{1}{n}\sum_{i=1}^n X_i$                         |
| Proportion of individuals with disease $\pi$              | Proportion in sample with disease | $P = \frac{1}{n}\sum_{i=1}^n X_i$                         |

---

## Example: Estimating Relative Risk

```{r}
full_show <- read_csv('../../data/SHOW_subset_of_vars.csv')

samples_RR <- read_rds('../../data/R_output/samples_RR.Rds')
RRs <- read_rds('../../data/R_output/RRs.Rds')

N <- max(samples_RR$i)

sample_size_RR <- sum(samples_RR$i == 1)
show_depr_by_gender <- full_show %>% 
  select(id, depression_severity_binary, gender) %>% 
  filter(complete.cases(.)) %>% 
  mutate(gender = if_else(str_detect(gender, "Female"), 0, 1))

# dat <- show_depr_by_gender
# trt <- quo(gender)
# out <- quo(depression_severity_binary)


RR <- function(dat, trt, out){
  
  trt <- enquo(trt)
  out <- enquo(out)
  
  tmp <- dat %>% 
    group_by(!!trt, !!out, .drop = FALSE) %>%
    summarize(n = n()) %>%
    #count(!!trt, !!out) %>% 
    group_by(!!trt) %>% 
    mutate(totals = sum(n)) %>% 
    filter(!!out == 1) %>% 
    summarise(R = n/totals)

  return(filter(tmp, !!trt == 1)$R/filter(tmp, !!trt == 0)$R)
}


true_RR <- RR(show_depr_by_gender, trt = gender, out = depression_severity_binary)

logRR_var <- show_depr_by_gender %>% 
  count(gender, depression_severity_binary) %>% 
  group_by(gender) %>% 
  mutate(p_gender = sum(n)) %>% 
  ungroup() %>% 
  mutate(p_gender = p_gender/sum(n)) %>% 
  spread(depression_severity_binary, n) %>% 
  mutate(var_contribution = (`0`/`1`)/(sample_size_RR*p_gender)) %>% 
  pull(var_contribution) %>% sum

samples_RR %>% 
  filter(i == 1) %>% 
  #mutate(gender = if_else(gender == 1, "[1] Male", "[2] Female")) %>% 
  select(id) %>% 
  left_join(full_show, by = 'id') %>% 
  DT::datatable(options(pageLength = 3))
```


---

To find the relative risk, create 2 by 2 contingency table:

```{r}
samples_RR %>% 
  filter(i == 1) %>% 
  mutate(gender = if_else(gender == 0, 'Female', 'Male')) %>% 
  janitor::tabyl(depression_severity_binary, gender) %>% 
  janitor::adorn_totals(where = c('row', 'col')) %>% 
  DT::datatable()
```

The relative risk is then calculated as 

\begin{align*}
  \frac{\text{proportion of males with severe depression}}{\text{proportion of women with severe depression}} &= \frac{6/34}{13/41} \\
  &\approx `r round(RRs[["RR"]][1], digits = 2)`.
\end{align*}

---

.center[
```{r out.height = 400, out.width = 500}
RRs %>% 
  ungroup() %>% 
  ggplot(aes(x = RR)) + 
    geom_histogram(aes(y = ..density..),
                   bins = floor(N/200)) + 
    geom_vline(aes(xintercept = true_RR, color = 'True RR'), linetype = 'dashed') + 
    scale_x_continuous(breaks = 0:6) +
    scale_y_continuous(expand = expand_scale(mult = c(0, 0.025))) + 
    scale_color_discrete("", direction = -1)
```
]

---

.center[
```{r out.width = 500, out.height = 400}
RRs %>% 
  ungroup() %>% 
  ggplot(aes(x = log(RR))) + 
    geom_histogram(aes(y = ..density..),
                   bins = floor(N/300)) + 
    stat_function(fun = dnorm, args = list(mean = log(true_RR), sd = sqrt(logRR_var))) + 
    geom_vline(aes(xintercept = log(true_RR), color = 'True RR'), linetype = 'dashed') + 
    scale_x_continuous(breaks = 0:6) +
    scale_y_continuous(expand = expand_scale(mult = c(0, 0.025))) + 
    scale_color_discrete("", direction = -1)
```
]

---
layout: true

# Central Limit Theorem

---


Let $X_1, X_2, ..., X_n$ be a simple random sample from a population with mean $\mu$ and variance $\sigma^2$ (i.e. $E(X_i) = \mu$ and $\text{Var}(X_i) = \sigma^2$ for all $i$). Then, as long as $n$ is large enough, the *average* $\bar{X} = \frac{1}{n} \sum_{i=1}^n X_i$ is approximately $N(\mu, \sigma^2 / n)$.

In words

* it almost doesn't matter where you start, if you take a sample, and form an average, then the outcome will be Normal!

* plus, you'll be centered around the true value!!

* PLUS, the more samples you use for your average, the smaller variance you'll have!!!

---

## Example 1: mean BMI

.center[
```{r fig.height = 4, fig.width = 6}
full_show %>% 
  filter(bmi < 159) %>% 
  ggplot(aes(x = bmi)) + 
    geom_histogram(aes(y = ..density..),
                   binwidth = 5) +
    stat_function(fun = dnorm, args = list(mean = mean(full_show$bmi, na.rm = T),
                                          sd = sd(full_show$bmi, na.rm = T)/sqrt(10)),
                  aes(color = 'n = 10')) +
    stat_function(fun = dnorm, args = list(mean = mean(full_show$bmi, na.rm = T),
                                          sd = sd(full_show$bmi, na.rm = T)/sqrt(50)),
                  aes(color = 'n = 50')) + 
    geom_vline(xintercept = mean(full_show$bmi, na.rm = T),
               color = 'red', linetype = 'dashed') +
    scale_color_discrete()
```
]

---

.center[
```{r fig.height = 4, fig.width = 6}
samples %>%
  mutate(mean = map(.x = data,
                    ~.x %>% group_by(depression) %>% summarize(m = mean(bmi, na.rm = TRUE)))) %>%
  unnest(col = 'mean') %>% 
  group_by(depression) %>% 
  left_join(show %>% 
              group_by(depression) %>% 
              summarize(overall_m = mean(bmi, na.rm = T),
                        sd = sd(bmi, na.rm = T))) %>% 
  mutate(y = dnorm(x = m, mean = overall_m, sd = sd/sqrt(50))) %>% 
  ggplot(aes(x = m)) + 
    geom_histogram(aes(y = ..density..),
                   binwidth = 1, boundary = 0) +
    geom_line(aes(y = y)) +
    facet_grid(depression~.) +
    geom_vline(aes(xintercept = overall_m),
               color = 'red', linetype = 'dashed') +
    scale_color_discrete()
```
]

---

## Example 2: estimating proportion

How do we estimate the proportion of people with a disease in a population? 

$$
  p =\frac{\text{number of people with disease}}{\text{total number of people}} =\frac{1}{n}\sum_{i=1}^n x_i,
$$

where $x_i=1$ if individual $i$ has the disease, and $x_i = 0$ otherwise. 

$p$ is just an average! So as long as $n$ is "large enough", we can utilize the CLT when calculating probabilities:

The prevalence of diabetes in the adult population of Wisconsin is approximately $10.6\%$. That is, if we randomly select an adult in Wisconsin, the probability of that adult having diabetes is approximately $10.6\%$. What is the probability that less than $10$ individuals in a sample of $50$ have diabetes? I.e. the proportion of individuals with diabetes is less than $0.2$. 

---

## Example: estimating proportion

Binomial problem. $X_1,...,X_{50}$ independent random variables indicating whether each of the $50$ adults have diabetes (1) or not (0). Each random variable is a $\text{Bernoulli}(0.106)$ random variable. Let $Y = X_1 + ... + X_{50}$. We are interested in $P(Y < 10)$.

---

## Example: estimating proportion

To calculate probabilities, we need to find the distribution of the random variable. $Y$ is binomially distributed with $n=50$ and $p = 0.106$. This distribution looks like this. We are interested in the area shaded red. 

.center[
```{r fig.width = 3, fig.height = 3, out.width = 400, out.height = 400}
ggplot(data = tibble(x = 10:50, y = dbinom(x = 10:50, size = 50, prob = 0.106)),
       aes(x = x, y = y)) +
  geom_bar(stat='identity', width = 1) +
  geom_bar(data = tibble(x = 0:9, y = dbinom(x = 0:9, size = 50, prob = 0.106)),
           fill = 'red', stat = 'identity', alpha = 0.5, color = NA)
```

]

---

## Example: estimating proportion

Can calculate directly: 

$P(Y < 10) = \sum_{i=0}^9 P(Y = i) = \sum_{i=0}^9 {50 \choose i}0.106^i (1-0.106)^{50-i} = `r round(pbinom(q = 9, size = 50, prob = 0.106), 5)`$

---

## Example: estimating proportion

Or, using a normal approximation, we can find the area under the normal curve:

.pull-left[
```{r fig.width = 3, fig.height = 3, out.width = 300, out.height = 300}
ggplot(data = tibble(x = seq(0, 50, 0.1), y = dnorm(x = x, mean = 50*0.106, sd = sqrt(50*0.106*(1-0.106)))), 
       aes(x = x, y = y)) +
  geom_line() +
  geom_area(data = tibble(x = seq(0, 9, 0.1), y = dnorm(x = x, mean = 50*0.106, sd = sqrt(50*0.106*(1-0.106)))))
```
]

.pull-right[
This area is `r round(pnorm(9, mean = 50*0.106, sd = sqrt(50*0.106*(1-0.106))), digits = 5)`.
]